# Rat Rig V-core 3 Klipper Config
# Documentation: https://os.ratrig.com

# The first thing you'll need to do is go through this file and comment out / uncomment 
# the files and/or settings you need.
# You'll be able to print just fine with this config as it is, but it is recommended
# that you follow these steps to properly calibrate your printer:
# 0) Sanity check and PID Tuning: https://www.klipper3d.org/Config_checks.html
# 1) Pressure Advance: https://www.klipper3d.org/Pressure_Advance.html
# 2) Skew Correction: https://www.klipper3d.org/skew_correction.html
# 3) Resonance Compensation: https://www.klipper3d.org/Resonance_Compensation.html

# Read more about klipper here: https://www.klipper3d.org/Overview.html

### CONTROL BOARD
#[include config/boards/btt-skr-pro-12/config.cfg]
# [include config/boards/btt-octopus-11/config.cfg]
# [include config/boards/btt-octopus-pro-446/config.cfg]
# [include config/boards/btt-octopus-pro-429/config.cfg]
# [include config/boards/fysetc-spider/config.cfg]
[include spider.cfg]

### BASE SETUP
[include config/printers/v-core-3/v-core-3.cfg]
#[include config/printers/v-core-3/steppers.cfg]
#[include config/printers/v-core-3/tmc2209.cfg]
[include overrides/steppers.cfg]
[include overrides/tmc2209.cfg]


### Stepper mechanical overrides
[stepper_x]
dir_pin: !x_dir_pin # Add ! in front of pin name to reverse X stepper direction
rotation_distance: 40 # 40 for 20 tooth 2GT pulleys, 32 for 16 tooth 2GT pulleys

[stepper_y]
dir_pin: !y_dir_pin # Add ! in front of pin name to reverse Y stepper direction
rotation_distance: 40 # 40 for 20 tooth 2GT pulleys, 32 for 16 tooth 2GT pulleys

[stepper_z]
dir_pin: z0_dir_pin # Add ! in front of pin name to reverse Z stepper direction
rotation_distance: 4 # 4 for TR8*4 lead screws

[stepper_z1]
dir_pin: z1_dir_pin # Add ! in front of pin name to reverse Z1 direction
rotation_distance: 4 # 4 for TR8*4 lead screws

[stepper_z2]
dir_pin: z2_dir_pin # Add ! in front of pin name to reverse Z2 direction
rotation_distance: 4 # 4 for TR8*4 lead screws

[extruder]
dir_pin: !e_dir_pin # Remove ! in front of pin name to reverse extruder direction

# Uncomment this next line if you have an ADXL345 connected to your control board
[include config/printers/v-core-3/input-shaper.cfg] 

### HOMING
# BL Touch
#[include config/z-probe/bltouch.cfg]
#[bltouch]
#z_offset: 0.0 # Adjust this to fit your setup

# Inductive/Capacitive probe
[include config/z-probe/probe.cfg]
[probe]
#z_offset: 0.0 # Adjust this to fit your setup
#pin: ^probe_pin # For NPN NC probes such as the Super Pinda / Vinda / SupCR / Decoprobe probes.
#pin: ^!probe_pin # NPN NO (refer to the specs on your probe)
pin: probe_pin # PNP NO (refer to the specs on your probe)
#pin: !probe_pin # PNP NC (refer to the specs on your probe)
speed: 15
samples: 1
sample_retract_dist: 2
lift_speed: 15

# Physical endstops
[include config/printers/v-core-3/physical-endstops.cfg]
[safe_z_home]
home_xy_position: 150,150 # 300mm printer
#home_xy_position: 200,200 # 400mm printer
#home_xy_position: 250,250 # 500mm printer

# Endstop position
# Adjust this to your setup
# Note: might need fine tuning.
[stepper_y]
position_endstop: 300  # 300mm printer
#position_endstop: 400 # 400mm printer
#position_endstop: 500 # 500mm printer
[stepper_x]
position_endstop: 0

# Sensorless homing (Beware: this requires manual tinkering and does not work if your x/y stepper drivers
# have clipped DIAG pins). It is strongly encouraged to use physical endstops if you're a beginner.
# If you still wish to proceed, copy config/templates/sensorless-homing-tmc2209.cfg to the root directory and 
# remove the # from the line below.
#[include sensorless-homing-tmc2209.cfg]

### PHYSICAL DIMENSIONS
# Remove the # from your printer size below. 
# Similarly add a # in front of [include config/printers/v-core-3/300.cfg] if you have a bigger machine.
[include config/printers/v-core-3/300.cfg]
#[include config/printers/v-core-3/400.cfg]
#[include config/printers/v-core-3/500.cfg]

### SPEED & ACCEL
# Acceleration
# Check https://www.klipper3d.org/Resonance_Compensation.html for input shaper calibration.
#[include config/printers/v-core-3/speed-limits-basic.cfg]
# Do not enable this next line without actively cooled stepper drivers.
#[include config/printers/v-core-3/speed-limits-performance.cfg]
[include overrides/speed-limits-performance.cfg]

### EXTRUSION

# Extruder
#[include config/extruders/bmg.cfg]
# [include config/extruders/lgx.cfg]
# [include config/extruders/orbiter.cfg]
#[include config/extruders/orbiter-1004.cfg]
#[include overrides/orbiter-1004.cfg]
[include overrides/rapido-uhf-06.cfg]
# [include config/extruders/hemera.cfg]
# [include config/extruders/titan.cfg]

# Hotend
#[include config/hotends/v6.cfg]
# [include config/hotends/copperhead.cfg]
# [include config/hotends/mosquito.cfg]
# [include config/hotends/mosquito-magnum.cfg]
# [include config/hotends/dragon-standard-flow.cfg]
#[include config/hotends/dragon-high-flow.cfg]
[include overrides/dragon-high-flow.cfg]

# Pressure Advance
# Check https://www.klipper3d.org/Pressure_Advance.html for pressure advance tuning.
[extruder]
#pressure_advance: 0.05
nozzle_diameter: 0.4 # Remember to change this if you change nozzle diameter.

### HOTEND HEATING
# PID Tuning (Remember to run PID tuning before printing)
#control: pid
#pid_kp: 28.413
#pid_ki: 1.334
#pid_kd: 151.300

### BED HEATING
# BED PID Tuning (Remember to run PID tuning before printing)
#[heater_bed]
#control: pid
#pid_Kp: 22.2
#pid_Ki: 1.08
#pid_Kd: 114

### MACROS
[include config/macros.cfg]
[include config/shell-macros.cfg]
[include config/printers/v-core-3/macros.cfg]

### MACRO CONFIGURATION
[gcode_macro RatOS]
# Use absolute extrusion mode
# Set to True to use relative extrusion mode
variable_relative_extrusion: True
# Wait for extruder to reach 150 so an inductive probe (if present) is at a predictable temp. 
# Also allows the bed heat to spread a little, and softens any plastic that might be stuck to the nozzle.
# Set to False to disable
variable_preheat_extruder: True
# Calibrate the bed mesh in the START_PRINT macro.
# Set to false to skip BED_MESH_CALIBRATE, it will still load the BED_MESH 
# with the name "ratos", be sure to save your bed_mesh profile with that name.
# or override the _START_PRINT_BED_MESH macro to implement your own mesh handling logic.
variable_calibrate_bed_mesh: True
# Print a prime line at the end of the START_PRINT macro
# set to False to disable nozzle_priming.
variable_nozzle_priming: "primeline"
# Park in the back when waiting for the extruder to heat up
# set to "front" to park in the front, or "center" to park in the center.
variable_start_print_park_in: "back"
# Height to park it when waiting for extruder to heat.
variable_start_print_park_z_height: 50
# Skew profile to load before starting the print 
# uncomment this to use your calibrated skew correction profile.
#variable_skew_profile: "my_skew_profile"
# Park in the back after the print has ended or was cancelled.
# set to "front" to park in the front, or "center" to park in the center.
variable_end_print_park_in: "back"
# Park in the back when the print is paused.
# set to "front" to park in the front, or "center" to park in the center.
variable_pause_print_park_in: "back"
# Set the speed for travel moves in RatOS Macros in mm/s.
variable_macro_travel_speed: 200

### USER OVERRIDES
# Place all your overrides here
[printer]
max_velocity: 400
max_accel: 7000 #6000
max_accel_to_decel: 3500 #3000
#max_z_velocity: 15
#max_z_accel: 100
#max_z_velocity: 20
#max_z_accel: 150
square_corner_velocity: 15 #20 #10 #5

[bed_mesh]
#probe_count: 9,9
speed: 300

#####################################################################
#   Inreased X due Offset probe
#####################################################################
[stepper_x]
#position_max: 310
position_min: -5
#####################################################################
#   Extruder E-Steps & Currents
#####################################################################
[extruder]
rotation_distance: 4.6370	# Orbiter
#rotation_distance: 4.538184 # CR NanoExtruder

#####################################################################
#   For Mooncord (Discord Bot)
#####################################################################
[respond]
default_type: command

[idle_timeout]
timeout: 3600

[save_variables]
filename: ~/3ddruckerplausch.cfg

###############################################################################
# Fans & extra temp sensor(s)
###############################################################################
[controller_fan controller_fan]
max_power: 1.0
fan_speed: 1.0                      # full cooling not required
#hardware_pwm: True
cycle_time: 0.0001
#kick_start_time: 0.400
idle_timeout: 90
idle_speed: 0.5                   # slow down when idling
#heater: extruder, heater_bed

[controller_fan psu_fan]
pin: PC8
max_power: 1.0
fan_speed: 0.4                         # full cooling not required
#hardware_pwm: True
cycle_time: 0.0001
kick_start_time: 0.450
idle_timeout: 120
idle_speed: 0.2                        # slow down when idling
#heater: extruder, heater_bed

[heater_fan toolhead_cooling_fan]
fan_speed: 1

[fan_generic chamber_fan]
pin: PB1
max_power: 1.0
#shutdown_speed: 0.5
cycle_time: 0.0001     #10 kHz PWM signal
kick_start_time: 0.400
#hardware_pwm: True
#fan_speed: 0.8
#heater: heater_bed
#heater_temp: 30.0


[temperature_sensor Stepsticks]
sensor_type: ATC Semitec 104GT-2
sensor_pin: PC1

###############################################################################
# Resonance testing part
###############################################################################
[mcu rpi]
serial: /tmp/klipper_host_mcu

[adxl345]
cs_pin: rpi:None
axes_map: x,z,y
#   The accelerometer axis for each of the printer's x, y, and z axes.
#   This may be useful if the accelerometer is mounted in an
#   orientation that does not match the printer orientation. For
#   example, one could set this to "y,x,z" to swap the x and y axes.
#   It is also possible to negate an axis if the accelerometer
#   direction is reversed (eg, "x,z,-y"). The default is "x,y,z".

[resonance_tester]
accel_chip: adxl345
probe_points:
    150,150,20  # an example

[input_shaper]
shaper_freq_x: 75.8
shaper_type_x: mzv
shaper_freq_y: 75.6 #62.0
shaper_type_y: 2hump_ei #mzv

[delayed_gcode _CLEAR_DISPLAY]
gcode:
  M117

#[z_tilt]
#z_positions:
#	0,0
#	150,300
#	300,0

#points:
#	60,60
#	193,270
#	309,60

###############################################################################
# Firmware Retraction
###############################################################################
[firmware_retraction]
retract_speed: 60
unretract_extra_length: 0
unretract_speed: 30
retract_length: 0.5

###############################################################################
# Testing Playground
###############################################################################
#[bed_mesh]
#speed: 150
#probe_count: 10,10

###############################################################################
# Own Included files
###############################################################################  
[include additions/tasmotaswitch.cfg]				        # Tasmota Power switch control with Idle timeout
[include additions/print_time.cfg]                  # Statistics about total print time and save the to file
[include additions/pa_test.cfg]                     # Automated PA test procedure make sure you upload pa_test.gcode or create your own. Function can be called from the menu
#                                                   # After the test give the command PA_NORMAL to have the accelerations back to normal
[include additions/resonance_test.cfg]              # Automated Resonance testing with ADXL345
[include additions/flexplate.cfg] 				          # A Flexplate manager
[include additions/printing_feature.cfg] 			      # Show printing feature on display and reduce acceleration based on feature
[include additions/mini12864.cfg]                   # Mini 12864 LCD Display
[include additions/neopixel.cfg]                    # Neopixel LED strip
[include additions/logo.cfg]                        # Klipper start logo
[include additions/disable_xy.cfg]					# Disable X & Y Stepper when idle
[include additions/display_menu.cfg]				 # Menu items Display
[include additions/purge_line.cfg]				     # Longer Purge line
#[include additions/save_offset.cfg]				     # Button for saving Z_Offset to the printer.cfg
#[include additions/git_backup.cfg]					# Automatic backup to Github
[include additions/btt_sensor.cfg]					# BTT Smartt filament sensor
[include additions/servo_wiper.cfg]					# Servo Wiper control
[include additions/start_print_led.cfg]				# Start_Print with Wled macros added
#[include additions/adaptive_bed_mesh.cfg]			# Generate Bed Mesh based on Print size
###############################################################################
# Own Included files
###############################################################################
[include additions/menu_fast_infill.cfg]			# Menu items Fast infill
[include additions/fast_infill.cfg]					# Fast infill script (SuperSlicer addition required)

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 65.663
#*# pid_ki = 2.341
#*# pid_kd = 460.460
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 21.570
#*# pid_ki = 1.798
#*# pid_kd = 64.711
#*#
#*# [probe]
#*# z_offset = 0.965
#*#
#*# [bed_mesh ratos]
#*# version = 1
#*# points =
#*# 	0.108906, 0.100312, 0.063594, 0.059531, 0.097812, 0.123906, 0.177969
#*# 	0.098594, 0.072344, 0.045000, 0.042500, 0.081875, 0.102500, 0.147344
#*# 	0.079219, 0.062812, 0.040937, 0.039375, 0.062031, 0.090156, 0.133281
#*# 	0.071094, 0.056094, 0.036406, 0.036250, 0.064062, 0.075156, 0.132812
#*# 	0.079219, 0.066406, 0.035000, 0.032344, 0.048281, 0.072187, 0.123125
#*# 	0.115312, 0.103281, 0.070156, 0.064062, 0.074687, 0.095469, 0.140781
#*# 	0.167344, 0.160469, 0.125000, 0.102344, 0.126094, 0.126562, 0.176406
#*# tension = 0.2
#*# min_x = 20.0
#*# algo = bicubic
#*# y_count = 7
#*# mesh_y_pps = 2
#*# min_y = 20.0
#*# x_count = 7
#*# max_y = 260.0
#*# mesh_x_pps = 2
#*# max_x = 264.98
